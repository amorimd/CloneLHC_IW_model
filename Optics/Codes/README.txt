#############################################################################
# to get files with LHC (or HL-LHC) beta functions for all machine elements
# in the impedance model
#############################################################################

cd 2012/
# then launch (you need MADX - it's free, http://madx.web.cern.ch/madx/) 
./script.j
# Note: you can add lines in this script and/or change files like "thick_asbuilt_inj_2015modif.madx"
# to load other optics from the repository

# Note: a few examples of the kind of twiss files to be obtained are in the directory:
# twiss.asbuilt.b1.coll7tev.thick.tar.gz
# twiss.asbuilt.b1.coll7tev_oct_disp.thick
# twiss.asbuilt.b1.coll7tev_ph1collimators.thick
# (the first one is zipped)

# then:
cd ../
# open with Matlab® (commercial software, http://www.mathworks.com/products/matlab/)
# the file "commands_betaLHC_fromtwiss_2012.m" and go to the cell beginning with
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% new function to get all beta functions (and lengths)
% write everything in [twissfilename]_beta_elements.dat
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# there are several examples of generation of the beta functions
# using the function "meanbeta_all" and the twiss files generated by the previous
# script (script.j)
# this produces a file "[twissfilename]_beta_elements.dat"
# that can be directly used by the LHC impedance model generators (see in 
# ../PYTHON_codes_and_scripts/LHC_impedance_and_scripts )


#########################################################################
# Collimators beta functions (see also "some readme.txt", or maybe better
# see 2012/README_coll.txt )
#########################################################################

# in the "2012/" directory, after having launched the script "script.j" (see above)
# for e.g. b1 at injection, do:

cp twiss.asbuilt.b1.injection_ph1collimators.thick coll_ph1_beta_450GeV_b1.txt

# suppress (with vi) 45 lines at the beginning, 1 line after column headers, and
# the * at the beginning of the column headers

awk '{print $1,"\t",$5,"\t",$6}' coll_ph1_beta_450GeV_b1.txt > out

# suppress with vi 2 lines with collimators from the other beam (TCTVB.4R8 and TCLIA.4L8 for B1,
# TCTVB.4L8 and TCLIA.4R2 for B2)

# suppress with vi all " (use the command :%s/"//g )

# with vi, add "A" to BETX and BETY (gives BETAX and BETAY)

mv out coll_ph1_beta_450GeV_b1.txt


####################################################################
# LHC octupoles detuning coefficients and Q''
####################################################################

# in the "2012/" directory, after having launched the script "script.j" (see above)
cd ../
# open with Matlab® (commercial software, http://www.mathworks.com/products/matlab/)
# the file "commands_betaLHC_fromtwiss_2012.m" and go to the cell beginning with
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% octupoles
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

# there are examples to get the detuning coefficients and Q'' (results are matrices)
# you can get info about what is output there, in:
# - at the beginning of the function "octupole.m" in this directory,
# - at the beginning of the function "detuning_coef_oct_LHC" in 
# "PYTHON_codes_and_scripts/DELPHI_Python/DELPHI.py"
# (in the latter the hard-coded coefficients e.g. 267065 for ax, etc.)
# are the results of the "a" coefficients from octupole.m)


######################################################################
# first trial to introducte beta-beating in IR7, to decrease impedance
######################################################################

# in the Matlab® file "commands_betaLHC_fromtwiss_2012.m" there is a first
# attempt to decrease impedance by introducing beta-beating in IR7.

# look for the cell beginning with:
%% test beta-beating in IR7
# this cell is to test the optics obtained after some matching procedure,
# that can be done thanks to the madx scripts (giving twiss files)
2012/thick_asbuilt_coll7TeV_test_betabeatIR7_prematch_b1_b2.madx
2012/thick_asbuilt_coll7TeV_test_betabeatIR7_prematch.madx

