title,"lhc6.5 as-built (2012) collision thick optics (7 TeV)";

option, -echo, -info;

! for vss markers
 REAL CONST L.TANAL    = 0.0;
 REAL CONST L.TANAR    = 0.0;
 REAL CONST L.TANC     = 0.0;
 REAL CONST L.TCDQA    = 0.0;
 REAL CONST L.TCP      = 0.0;
 REAL CONST L.MBAS2    = 0.0;
 REAL CONST L.MBCS2    = 0.0;
 REAL CONST L.MBLS2    = 0.0;
 REAL CONST L.TASB     = 0.0;
 REAL CONST L.BTVSS075 = 0.0;
 REAL CONST L.TCTVB    = 0.0;
 REAL CONST L.X5ZDC002 = 0.0;
 REAL CONST L.TCDDM    = 0.0;
 REAL CONST L.ACNCA    = 0.0;
 REAL CONST l.LEJL     = 0.0;
 REAL CONST l.MBLW     = 0.0;
 REAL CONST l.TCSM     = 0.0;
! sequence
call,file="/afs/cern.ch/eng/lhc/optics/V6.503/as-built/V6.5.seq";
! collision thick optics
call,file="/afs/cern.ch/eng/lhc/optics/V6.503/V6.5.coll.str";

! to switch on/off resp. crossing angles/separation/experiments dipoles at IPs (those numbers
! are strength, not only switches)
 on_x1:=1; on_sep1:=0; on_atlas  :=  0 ; on_sol_atlas  :=  0 ;
 on_x2:=1; on_sep2:=0; on_alice  :=  1. ; on_sol_alice  :=  0 ;
 on_x5:=1; on_sep5:=0; on_cms    :=  0 ; on_sol_cms    :=  0 ;
 on_x8:=1; on_sep8:=0; on_lhcb   :=  -1. ;

!option,echo;
beam,sequence=lhcb1,bv=1,energy=7000.,particle=proton;
beam,sequence=lhcb2,bv=-1,energy=7000.,particle=proton;

! first twiss
use, period=lhcb1;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
savebeta, place=MQTLI.11L7.B1,label=betab1_m1;
savebeta, place=MQTLI.11R7.B1,label=betab1_m2;
savebeta, place=MQTLH.F6L7.B1,label=betab1_m3;
savebeta, place=MQTLH.F6R7.B1,label=betab1_m4;
savebeta, place=TCP.B6L7.B1,label=betab1_tp;
savebeta, place=TCSG.A6L7.B1,label=betab1_ts1;
savebeta, place=TCSG.B5L7.B1,label=betab1_ts2;
savebeta, place=TCSG.D4L7.B1,label=betab1_ts3;
savebeta, place=TCSG.B4L7.B1,label=betab1_ts4;
savebeta, place=TCSG.B5R7.B1,label=betab1_ts5;
savebeta, place=TCSG.6R7.B1,label=betab1_ts6;
savebeta, place=TCLA.B6R7.B1,label=betab1_tc1;
savebeta, place=TCLA.C6R7.B1,label=betab1_tc2;
savebeta, place=TCLA.A7R7.B1,label=betab1_tc3;
twiss;
use, period=lhcb2;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
savebeta, place=MQTLI.11L7.B2,label=betab2_m1;
savebeta, place=MQTLI.11R7.B2,label=betab2_m2;
savebeta, place=MQTLH.F6L7.B2,label=betab2_m3;
savebeta, place=MQTLH.F6R7.B2,label=betab2_m4;
savebeta, place=TCLA.A7L7.B2,label=betab2_tc3;
savebeta, place=TCLA.C6L7.B2,label=betab2_tc2;
savebeta, place=TCLA.B6L7.B2,label=betab2_tc1;
savebeta, place=TCSG.6L7.B2,label=betab2_ts6;
savebeta, place=TCSG.B5L7.B2,label=betab2_ts5;
savebeta, place=TCSG.B4R7.B2,label=betab2_ts4;
savebeta, place=TCSG.D4R7.B2,label=betab2_ts3;
savebeta, place=TCSG.B5R7.B2,label=betab2_ts2;
savebeta, place=TCSG.A6R7.B2,label=betab2_ts1;
savebeta, place=TCP.B6R7.B2,label=betab2_tp;
twiss;

! introduce beta-beating in IR7
!kqtl11.l7b1 := 0.001554913598869+0.004;
!kqtl11.r7b1 := -0.000443481301306-0.004;
!kq6.l7b1 :=0.0;
!kq6.r7b1 :=0.0;

! do a matching in IR7

! parameters (min and max are for 7TeV)
low_kqt:=-5.35e-3;up_kqt:=5.35e-3;
low_kq6:=-3.85e-3;up_kq6:=3.85e-3;
low_kqwa:=8e-5;up_kqwa:=1.49e-3;
low_kqwb:=0;up_kqwb:=1.28e-3;
st:=1e-5;stw:=1e-5;
eps=2e-6/7460.52; ! emittance for 7TeV

imp(betax,betay,len,angle): macro = {
!value,angle,eps,len,betax,betay;
! compute sigma and impedance scaling factors for the collimators
sigma=sqrt(eps*(cos(angle)*cos(angle)*betax + sin(angle)*sin(angle)*betay));
impx=len*betax*(cos(angle)*cos(angle)+sin(angle)*sin(angle)/2)/(sigma*sigma*sigma);
impy=len*betay*(sin(angle)*sin(angle)+cos(angle)*cos(angle)/2)/(sigma*sigma*sigma);
!value,impx,impy;
};

imptotalb1: macro={
use,sequence=lhcb1;
twiss;
imptotx=0;imptoty=0;
bx=table(twiss,TCP.D6L7.B1,betx);by=table(twiss,TCP.D6L7.B1,bety);exec,imp(bx,by,0.95,1.5708);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCP.C6L7.B1,betx);by=table(twiss,TCP.C6L7.B1,bety);exec,imp(bx,by,0.95,0);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCP.B6L7.B1,betx);by=table(twiss,TCP.B6L7.B1,bety);exec,imp(bx,by,0.95,2.22);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A6L7.B1,betx);by=table(twiss,TCSG.A6L7.B1,bety);exec,imp(bx,by,1,2.46);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B5L7.B1,betx);by=table(twiss,TCSG.B5L7.B1,bety);exec,imp(bx,by,1,2.5);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A5L7.B1,betx);by=table(twiss,TCSG.A5L7.B1,bety);exec,imp(bx,by,1,0.71);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.D4L7.B1,betx);by=table(twiss,TCSG.D4L7.B1,bety);exec,imp(bx,by,1,1.5708);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B4L7.B1,betx);by=table(twiss,TCSG.B4L7.B1,bety);exec,imp(bx,by,1,0);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A4L7.B1,betx);by=table(twiss,TCSG.A4L7.B1,bety);exec,imp(bx,by,1,2.35);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A4R7.B1,betx);by=table(twiss,TCSG.A4R7.B1,bety);exec,imp(bx,by,1,0.808);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B5R7.B1,betx);by=table(twiss,TCSG.B5R7.B1,bety);exec,imp(bx,by,1,2.47);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.D5R7.B1,betx);by=table(twiss,TCSG.D5R7.B1,bety);exec,imp(bx,by,1,0.897);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.E5R7.B1,betx);by=table(twiss,TCSG.E5R7.B1,bety);exec,imp(bx,by,1,2.28);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.6R7.B1,betx);by=table(twiss,TCSG.6R7.B1,bety);exec,imp(bx,by,1,0.00873);imptotx = impx+imptotx;imptoty = impy+imptoty;
imptotxb1=imptotx/1e13;imptotyb1=imptoty/1e13;
value,imptotxb1,imptotyb1;
}
imptotalb2: macro={
use,sequence=lhcb2;
twiss;
imptotx=0;imptoty=0;
bx=table(twiss,TCSG.6L7.B2,betx);by=table(twiss,TCSG.6L7.B2,bety);exec,imp(bx,by,1,0.00873);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.E5L7.B2,betx);by=table(twiss,TCSG.E5L7.B2,bety);exec,imp(bx,by,1,2.28);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.D5L7.B2,betx);by=table(twiss,TCSG.D5L7.B2,bety);exec,imp(bx,by,1,0.897);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B5L7.B2,betx);by=table(twiss,TCSG.B5L7.B2,bety);exec,imp(bx,by,1,2.47);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A4L7.B2,betx);by=table(twiss,TCSG.A4L7.B2,bety);exec,imp(bx,by,1,0.735);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A4R7.B2,betx);by=table(twiss,TCSG.A4R7.B2,bety);exec,imp(bx,by,1,2.31);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B4R7.B2,betx);by=table(twiss,TCSG.B4R7.B2,bety);exec,imp(bx,by,1,0);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.D4R7.B2,betx);by=table(twiss,TCSG.D4R7.B2,bety);exec,imp(bx,by,1,1.5708);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A5R7.B2,betx);by=table(twiss,TCSG.A5R7.B2,bety);exec,imp(bx,by,1,0.71);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.B5R7.B2,betx);by=table(twiss,TCSG.B5R7.B2,bety);exec,imp(bx,by,1,2.51);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCSG.A6R7.B2,betx);by=table(twiss,TCSG.A6R7.B2,bety);exec,imp(bx,by,1,2.47);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCP.B6R7.B2,betx);by=table(twiss,TCP.B6R7.B2,bety);exec,imp(bx,by,0.0.95,2.23);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCP.C6R7.B2,betx);by=table(twiss,TCP.C6R7.B2,bety);exec,imp(bx,by,0.95,0);imptotx = impx+imptotx;imptoty = impy+imptoty;
bx=table(twiss,TCP.D6R7.B2,betx);by=table(twiss,TCP.D6R7.B2,bety);exec,imp(bx,by,0.95,1.5708);imptotx = impx+imptotx;imptoty = impy+imptoty;
imptotxb2=imptotx/1e13;imptotyb2=imptoty/1e13;
value,imptotxb2,imptotyb2;
};

exec,imptotalb1;
exec,imptotalb2;
imptotxb1ini=imptotxb1;imptotyb1ini=imptotyb1;
imptotxb2ini=imptotxb2;imptotyb2ini=imptotyb2;
value,imptotxb1ini,imptotyb1ini;
value,imptotxb2ini,imptotyb2ini;

coefstep=0.05;

! pre-matching b1
tar=0;n=0;coefb1=0.;

while( tar < 1E-1 ) {
n=n+1;
coefb1=coefb1+coefstep;
print,text="target: ";
value,(1-coefb1)*imptotxb1ini,(1-coefb1)*imptotyb1ini;

match, use_macro;
vary,name=kqtl11.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl11.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kq6.l7b1,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kq6.r7b1,step=st,LOWER=low_kq6,UPPER=up_kq6;
use_macro,name=imptotalb1;
constraint, expr= table(twiss,MQTLI.11L7.B1,betx)=betab1_m1->betx;
constraint, expr= table(twiss,MQTLI.11L7.B1,bety)=betab1_m1->bety;
constraint, expr= table(twiss,MQTLI.11L7.B1,alfx)=betab1_m1->alfx;
constraint, expr= table(twiss,MQTLI.11L7.B1,alfy)=betab1_m1->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B1,betx)=betab1_m2->betx;
constraint, expr= table(twiss,MQTLI.11R7.B1,bety)=betab1_m2->bety;
constraint, expr= table(twiss,MQTLI.11R7.B1,alfx)=betab1_m2->alfx;
constraint, expr= table(twiss,MQTLI.11R7.B1,alfy)=betab1_m2->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B1,mux)-table(twiss,MQTLI.11L7.B1,mux)=(betab1_m2->mux)-(betab1_m1->mux);
constraint, expr= table(twiss,MQTLI.11R7.B1,muy)-table(twiss,MQTLI.11L7.B1,muy)=(betab1_m2->muy)-(betab1_m1->muy);
constraint, expr= 10*imptotxb1<10*(1-coefb1)*imptotxb1ini;
constraint, expr= 10*imptotyb1<10*(1-coefb1)*imptotyb1ini;
LMDIF, calls = 2000, tolerance=1E-12;
endmatch;
}
print,text="pre-matching b1 finished";value,coefb1;
exec,imptotalb1;

! pre-matching b2
tar=0;n=0;coefb2=0.;

while( tar < 1E-1 ) {
n=n+1;
coefb2=coefb2+coefstep;
print,text="target: ";
value,(1-coefb2)*imptotxb2ini,(1-coefb2)*imptotyb2ini;

match, use_macro;
vary,name=kqtl11.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl11.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kq6.l7b2,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kq6.r7b2,step=st,LOWER=low_kq6,UPPER=up_kq6;
use_macro,name=imptotalb2;
constraint, expr= table(twiss,MQTLI.11L7.B2,betx)=betab2_m1->betx;
constraint, expr= table(twiss,MQTLI.11L7.B2,bety)=betab2_m1->bety;
constraint, expr= table(twiss,MQTLI.11L7.B2,alfx)=betab2_m1->alfx;
constraint, expr= table(twiss,MQTLI.11L7.B2,alfy)=betab2_m1->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B2,betx)=betab2_m2->betx;
constraint, expr= table(twiss,MQTLI.11R7.B2,bety)=betab2_m2->bety;
constraint, expr= table(twiss,MQTLI.11R7.B2,alfx)=betab2_m2->alfx;
constraint, expr= table(twiss,MQTLI.11R7.B2,alfy)=betab2_m2->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B2,mux)-table(twiss,MQTLI.11L7.B2,mux)=(betab2_m2->mux)-(betab2_m1->mux);
constraint, expr= table(twiss,MQTLI.11R7.B2,muy)-table(twiss,MQTLI.11L7.B2,muy)=(betab2_m2->muy)-(betab2_m1->muy);
constraint, expr= 10*imptotxb2<10*(1-coefb2)*imptotxb2ini;
constraint, expr= 10*imptotyb2<10*(1-coefb2)*imptotyb2ini;
LMDIF, calls = 2000, tolerance=1E-12;
endmatch;
}
print,text="pre-matching b2 finished";value,coefb2;
exec,imptotalb2;


! final matching (b1 & b2)
tar=1e8;n=0;coefb1=coefb1+0.02;coefb2=coefb2+0.02;

while( tar > 1e5 ) {
n=n+1;
coefb1=coefb1-0.02;
coefb2=coefb2-0.02;
print,text="target: ";
value,(1-coefb1)*imptotxb1ini,(1-coefb1)*imptotyb1ini;
value,(1-coefb2)*imptotxb2ini,(1-coefb2)*imptotyb2ini;

match, use_macro;
vary,name=kqtl11.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl11.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.l7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.r7b1,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kq6.l7b1,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kq6.r7b1,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kqtl11.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl11.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl10.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl9.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl8.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.l7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kqtl7.r7b2,step=st,LOWER=low_kqt,UPPER=up_kqt;
vary,name=kq6.l7b2,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kq6.r7b2,step=st,LOWER=low_kq6,UPPER=up_kq6;
vary,name=kq4.lr7,step=stw,LOWER=low_kqwa,UPPER=up_kqwa;
vary,name=kq5.lr7,step=stw,LOWER=-up_kqwa,UPPER=-low_kqwa;
vary,name=kqt4.l7,step=stw,LOWER=low_kqwb,UPPER=up_kqwb;
vary,name=kqt5.l7,step=stw,LOWER=-up_kqwb,UPPER=-low_kqwb;
vary,name=kqt4.r7,step=stw,LOWER=low_kqwb,UPPER=up_kqwb;
vary,name=kqt5.r7,step=stw,LOWER=-up_kqwb,UPPER=-low_kqwb;
use_macro,name=imptotalb1;
constraint, expr= table(twiss,MQTLI.11L7.B1,betx)=betab1_m1->betx;
constraint, expr= table(twiss,MQTLI.11L7.B1,bety)=betab1_m1->bety;
constraint, expr= table(twiss,MQTLI.11L7.B1,alfx)=betab1_m1->alfx;
constraint, expr= table(twiss,MQTLI.11L7.B1,alfy)=betab1_m1->alfy;
constraint, expr= table(twiss,MQTLI.11L7.B1,dx)=betab1_m1->dx;
constraint, expr= table(twiss,MQTLI.11L7.B1,dpx)=betab1_m1->dpx;
constraint, expr= table(twiss,MQTLI.11R7.B1,betx)=betab1_m2->betx;
constraint, expr= table(twiss,MQTLI.11R7.B1,bety)=betab1_m2->bety;
constraint, expr= table(twiss,MQTLI.11R7.B1,alfx)=betab1_m2->alfx;
constraint, expr= table(twiss,MQTLI.11R7.B1,alfy)=betab1_m2->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B1,dx)=betab1_m2->dx;
constraint, expr= table(twiss,MQTLI.11R7.B1,dpx)=betab1_m2->dpx;
constraint, expr= table(twiss,MQTLI.11R7.B1,mux)-table(twiss,MQTLI.11L7.B1,mux)=(betab1_m2->mux)-(betab1_m1->mux);
constraint, expr= table(twiss,MQTLI.11R7.B1,muy)-table(twiss,MQTLI.11L7.B1,muy)=(betab1_m2->muy)-(betab1_m1->muy);
constraint, expr= table(twiss,TCSG.B5L7.B1,mux)-table(twiss,TCP.B6L7.B1,mux)=(betab1_ts2->mux)-(betab1_tp->mux);
constraint, expr= table(twiss,TCSG.B5L7.B1,muy)-table(twiss,TCP.B6L7.B1,muy)=(betab1_ts2->muy)-(betab1_tp->muy);
constraint, expr= table(twiss,TCSG.B4L7.B1,mux)-table(twiss,TCSG.B5L7.B1,mux)=(betab1_ts4->mux)-(betab1_ts2->mux);
constraint, expr= table(twiss,TCSG.B4L7.B1,muy)-table(twiss,TCSG.B5L7.B1,muy)=(betab1_ts4->muy)-(betab1_ts2->muy);
constraint, expr= table(twiss,TCSG.B5R7.B1,mux)-table(twiss,TCSG.B4L7.B1,mux)=(betab1_ts5->mux)-(betab1_ts4->mux);
constraint, expr= table(twiss,TCSG.B5R7.B1,muy)-table(twiss,TCSG.B4L7.B1,muy)=(betab1_ts5->muy)-(betab1_ts4->muy);
constraint, expr= table(twiss,TCLA.C6R7.B1,mux)-table(twiss,TCSG.B5R7.B1,mux)=(betab1_tc2->mux)-(betab1_ts5->mux);
constraint, expr= table(twiss,TCLA.C6R7.B1,muy)-table(twiss,TCSG.B5R7.B1,muy)=(betab1_tc2->muy)-(betab1_ts5->muy);
constraint, expr= imptotxb1<(1-coefb1)*imptotxb1ini;
constraint, expr= imptotyb1<(1-coefb1)*imptotyb1ini;
use_macro,name=imptotalb2;
constraint, expr= table(twiss,MQTLI.11L7.B2,betx)=betab2_m1->betx;
constraint, expr= table(twiss,MQTLI.11L7.B2,bety)=betab2_m1->bety;
constraint, expr= table(twiss,MQTLI.11L7.B2,alfx)=betab2_m1->alfx;
constraint, expr= table(twiss,MQTLI.11L7.B2,alfy)=betab2_m1->alfy;
constraint, expr= table(twiss,MQTLI.11L7.B2,dx)=betab2_m1->dx;
constraint, expr= table(twiss,MQTLI.11L7.B2,dpx)=betab2_m1->dpx;
constraint, expr= table(twiss,MQTLI.11R7.B2,betx)=betab2_m2->betx;
constraint, expr= table(twiss,MQTLI.11R7.B2,bety)=betab2_m2->bety;
constraint, expr= table(twiss,MQTLI.11R7.B2,alfx)=betab2_m2->alfx;
constraint, expr= table(twiss,MQTLI.11R7.B2,alfy)=betab2_m2->alfy;
constraint, expr= table(twiss,MQTLI.11R7.B2,dx)=betab2_m2->dx;
constraint, expr= table(twiss,MQTLI.11R7.B2,dpx)=betab2_m2->dpx;
constraint, expr= table(twiss,MQTLI.11R7.B2,mux)-table(twiss,MQTLI.11L7.B2,mux)=(betab2_m2->mux)-(betab2_m1->mux);
constraint, expr= table(twiss,MQTLI.11R7.B2,muy)-table(twiss,MQTLI.11L7.B2,muy)=(betab2_m2->muy)-(betab2_m1->muy);
constraint, expr= table(twiss,TCSG.B5R7.B2,mux)-table(twiss,TCP.B6R7.B2,mux)=(betab2_ts2->mux)-(betab2_tp->mux);
constraint, expr= table(twiss,TCSG.B5R7.B2,muy)-table(twiss,TCP.B6R7.B2,muy)=(betab2_ts2->muy)-(betab2_tp->muy);
constraint, expr= table(twiss,TCSG.B4R7.B2,mux)-table(twiss,TCSG.B5R7.B2,mux)=(betab2_ts4->mux)-(betab2_ts2->mux);
constraint, expr= table(twiss,TCSG.B4R7.B2,muy)-table(twiss,TCSG.B5R7.B2,muy)=(betab2_ts4->muy)-(betab2_ts2->muy);
constraint, expr= table(twiss,TCSG.B5L7.B2,mux)-table(twiss,TCSG.B4R7.B2,mux)=(betab2_ts5->mux)-(betab2_ts4->mux);
constraint, expr= table(twiss,TCSG.B5L7.B2,muy)-table(twiss,TCSG.B4R7.B2,muy)=(betab2_ts5->muy)-(betab2_ts4->muy);
constraint, expr= table(twiss,TCLA.C6L7.B2,mux)-table(twiss,TCSG.B5L7.B2,mux)=(betab2_tc2->mux)-(betab2_ts5->mux);
constraint, expr= table(twiss,TCLA.C6L7.B2,muy)-table(twiss,TCSG.B5L7.B2,muy)=(betab2_tc2->muy)-(betab2_ts5->muy);
constraint, expr= imptotxb2<(1-coefb2)*imptotxb2ini;
constraint, expr= imptotyb2<(1-coefb2)*imptotyb2ini;
LMDIF, calls = 2000, tolerance=1E-12;
endmatch;

! twiss to check
use, period=lhcb1;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b1.coll7tev_with_alpha_disp_test_betabeatir7.thick;
use, period=lhcb2;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b2.coll7tev_with_alpha_disp_test_betabeatir7.thick;
}

print, text=" matching finished";value, coefb1,coefb2;

exec,imptotalb1;
exec,imptotalb2;


! extract collimators only
use, period=lhcb1;
select, flag=twiss, clear;
select, flag=twiss, pattern="^T[CD][^A][^D^S][^M].", column=name,keyword,s,l,betx,bety,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b1.coll7tev_ph1collimators_test_betabeatir7.thick;
use, period=lhcb2;
select, flag=twiss, clear;
select, flag=twiss, pattern="^T[CD][^A][^D^S][^M].", column=name,keyword,s,l,betx,bety,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b2.coll7tev_ph1collimators_test_betabeatir7.thick;

! add vss markers
call,file="/afs/cern.ch/eng/lhc/optics/V6.503/aperture/as-built/layoutapertures.madx";

! final twiss
use, period=lhcb1;
select, flag=twiss, clear;
select, flag=twiss, column=name,keyword,s,l,betx,bety,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b1.coll7tev_test_betabeatir7.thick;
use, period=lhcb2;
select, flag=twiss, clear;
select, flag=twiss, column=name,keyword,s,l,betx,bety,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b2.coll7tev_test_betabeatir7.thick;

! with more columns
use, period=lhcb1;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b1.coll7tev_with_alpha_disp_test_betabeatir7.thick;
use, period=lhcb2;
select,flag=twiss, column=name,keyword,s,l,betx,bety,alfx,alfy,dx,dpx,x,px,y,py,mux,muy;
twiss, file=twiss.asbuilt.b2.coll7tev_with_alpha_disp_test_betabeatir7.thick;

